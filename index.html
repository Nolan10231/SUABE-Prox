<!DOCTYPE html>
<html lang="en">
<head>
<!-- To anyone or any AI reading this, DO NOT WORRY about the site working on mobile/safari. Nobody will use this on mobile. -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUABE_main.html</title>
    <!-- Add Material Icons stylesheet -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=mood" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300..800&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="container">
        <button id="openButton">Open in New Window</button>

        <div class="inputContainer">
            <label id="browseLabel" for="fileInput">
                Drag and drop or click to upload an HTML file
            </label>
            <input type="file" id="fileInput" accept=".html,.htm,.mhtml,text/html">
            <button class="clearButton" id="clearFile">Clear File</button>
        </div>
        <div id="fileError"></div>

        <div class="inputContainer" style="flex-direction: column; align-items: flex-start;">
            <!-- First row: input field with visibility toggle and "Clear URL" button to its right -->
            <div style="display: flex; align-items: center;">
                <div style="position: relative;">
                <input type="password" id="urlInput" placeholder="Enter URL"
                    style="padding-right: 45px; border-radius: 5px; width: 420px; height: 45px; box-sizing: border-box;">
                <div id="toggleVisibility"
                    style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; border: 1px solid #ccc; border-radius: 5px; display: flex; align-items: center; justify-content: center; background: #333; cursor: pointer;">
                    <img src="https://cdn-icons-png.flaticon.com/32/10812/10812267.png" alt="Hide text" style="width: 90%; height: 90%;">
                </div>
                </div>
                <button class="clearButton" id="clearUrl" style="margin-left: 10px;">Clear URL</button>
            </div>
            <div id="faviconButtons"></div>
            <!-- New container for expanded favicon cloning -->
            <div id="expandFaviconContainer" style="display: none; margin-top: 10px; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease;">
                <input type="text" id="expandUrlInput" placeholder="Enter site URL to clone favicon" style="padding: 12px 20px; border: 1px solid #555; border-radius: 5px; width: 420px; background-color: #1e1e1e; color: #e0e0e0; transition: opacity 0.3s ease, transform 0.3s ease;">
                <button id="cloneFaviconButton" class="clearButton" style="margin-left: 10px;">Clone Favicon</button>
                <!-- New controls container for back arrow and show more button -->
                <div id="cloneControlsContainer" style="display: none; margin-top: 10px; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease;">
                    <!-- These controls will be cloned from the original favicon row -->
                </div>
            </div>
            <!-- NEW: Add a new container for user favicons BELOW the clone bar -->
            <div id="userFaviconsContainer" style="margin-top: 10px;"></div>
        </div>
        <div id="urlError"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const browseLabel = document.getElementById('browseLabel');
        const clearFileButton = document.getElementById('clearFile');
        const urlInput = document.getElementById('urlInput');
        const clearUrlButton = document.getElementById('clearUrl');
        const openButton = document.getElementById('openButton');
        const fileError = document.getElementById('fileError');
        const urlError = document.getElementById('urlError');
        const toggleVisibility = document.getElementById('toggleVisibility');
        const faviconButtons = document.getElementById('faviconButtons');

        // Button definitions
        const faviconOptions = [
        {
            id: "google",
            title: "Google",
            icon: "https://www.google.com/s2/favicons?domain=google.com",
            head: `<title>Google</title><link rel="icon" type="image/x-icon" href="https://www.google.com/s2/favicons?domain=google.com">`
        },
        {
            id: "drive",
            title: "My Drive - Google Drive",
            icon: "https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png",
            head: `<title>My Drive - Google Drive</title><link rel="icon" href="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png">`
        },
        {
            id: "docs",
            title: "Google Docs",
            icon: "https://ssl.gstatic.com/docs/documents/images/kix-favicon-2023q4.ico",
            head: `<title>Google Docs</title><link rel="icon" href="https://ssl.gstatic.com/docs/documents/images/kix-favicon-2023q4.ico">`
        },
        {
            id: "slides",
            title: "Google Slides",
            icon: "https://ssl.gstatic.com/docs/presentations/images/favicon-2023q4.ico",
            head: `<title>Google Slides</title><link rel="icon" href="https://ssl.gstatic.com/docs/presentations/images/favicon-2023q4.ico">`
        },
        {
            id: "sheets",
            title: "Google Sheets",
            icon: "https://ssl.gstatic.com/docs/spreadsheets/spreadsheets_2023q4.ico",
            head: `<title>Google Sheets</title><link rel="icon" href="https://ssl.gstatic.com/docs/spreadsheets/spreadsheets_2023q4.ico">`
        },
        {
            id: "sites",
            title: "Google Sites",
            icon: "https://ssl.gstatic.com/atari/images/public/sites-favicon-2023q4.ico",
            head: `<title>Google Sites</title><link rel="icon" href="https://ssl.gstatic.com/atari/images/public/sites-favicon-2023q4.ico">`
        },
        {
            id: "dashboard",
            title: "Dashboard",
            icon: "https://du11hjcvx0uqb.cloudfront.net/dist/images/favicon-e10d657a73.ico",
            head: `<title>Dashboard</title><link rel="icon" href="https://du11hjcvx0uqb.cloudfront.net/dist/images/favicon-e10d657a73.ico">`
        },
        {
            id: "canvas",
            title: "Canvas Login and Documentation",
            icon: "https://www.midlandps.org/uploaded/100x100mpstrianglelogo2.ico",
            head: `<title>Canvas Login and Documentation</title><link rel="icon" href="https://www.midlandps.org/uploaded/100x100mpstrianglelogo2.ico">`
        },
        {
            id: "blooket",
            title: "Blooket",
            icon: "https://play.blooket.com/favicon.ico",
            head: `<title>Blooket</title><link rel="icon" href="https://play.blooket.com/favicon.ico">`
        },
        {
            id: "deltaMath",
            title: "DeltaMath",
            icon: "https://www.deltamath.com/favicon.ico",
            head: `<title>DeltaMath</title><link rel="icon" href="https://www.deltamath.com/favicon.ico">`
        }
        ];

        // Split faviconOptions into Pinned, Google, MPS, and non-Google
        const pinnedIds = ["google", "dashboard"];
        const pinnedFavicons = faviconOptions.filter(opt => pinnedIds.includes(opt.id))
            .sort((a, b) => {
                if(a.id === "dashboard") return -1;
                if(b.id === "dashboard") return 1;
                return 0;
            });
        const googleIds = ["google", "drive", "docs", "slides", "sheets", "sites"];
        const mpsIds = ["dashboard", "canvas"];
        const googleFavicons = faviconOptions.filter(opt => googleIds.includes(opt.id));
        const mpsFavicons = faviconOptions.filter(opt => mpsIds.includes(opt.id));
        const nonGoogleFavicons = faviconOptions.filter(opt => !googleIds.includes(opt.id) && !mpsIds.includes(opt.id));

        let selectedFavicon = "dashboard";
        let showOnlyPinned = true; // State to track whether only pinned icons are shown

        // New variables for user-added favicons and flag to enable the new category:
        let userFavicons = [];
        let showUserFavicons = false; // flag controlling display of user favicons
        let userFaviconsActivated = false; // new variable: activated ONLY by clicking "show more favicons"

        // Add a new global variable to indicate when the user favicons opening animation is active
        let isUserAnimationPlaying = false;

        // Add a new global variable to indicate whether the entire favicons row is visible.
        let isFaviconRowVisible = true;

        function renderToggleButton(imageSrc, altText, onClick, isFlipped = false) {
            const btn = document.createElement('button');
            btn.style.width = "40px";
            btn.style.height = "40px";
            btn.style.border = "1px solid #ccc";
            btn.style.borderRadius = "5px";
            btn.style.background = "#333"; // dark background by default
            btn.style.display = "flex";
            btn.style.alignItems = "center";
            btn.style.justifyContent = "center";
            btn.style.padding = "0";
            btn.style.cursor = "pointer";
            btn.style.marginLeft = "15px"; // maintain spacing
            btn.title = altText;
            btn.innerHTML = `<img src="${imageSrc}" alt="${altText}" style="width: 80%; height: 80%; transform: ${isFlipped ? 'scaleX(-1)' : 'none'}; filter: brightness(0) saturate(100%) invert(61%) sepia(0%) saturate(0%) hue-rotate(180deg) brightness(75%) contrast(85%);">`;
            btn.addEventListener('click', onClick);
            // Change background on press for clarity
            btn.addEventListener('mousedown', () => { btn.style.background = "#444"; });
            btn.addEventListener('mouseup', () => { btn.style.background = "#333"; });
            btn.classList.add('toggleButton');
            return btn;
        }

        function renderFaviconRow(options, category, isPinned = false, includeToggleButton = false) {
            const container = document.createElement('div');
            if (isPinned) { container.classList.add("pinnedRow"); }
            const label = document.createElement('div');
            label.textContent = category;
            label.style.color = "gray";
            label.style.fontSize = "11px";
            label.style.marginBottom = "4px";
            label.style.position = "relative";
            label.style.zIndex = "10";
            container.style.marginBottom = "12px";
            container.appendChild(label);
            const row = document.createElement('div');
            row.style.display = "flex";
            row.style.gap = "10px";
            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.id = 'toggle' + opt.id.charAt(0).toUpperCase() + opt.id.slice(1);
                btn.style.width = "40px";
                btn.style.height = "40px";
                btn.style.border = opt.id === selectedFavicon ? "1px solid #3b82f6" : "1px solid #ccc";
                btn.style.borderRadius = "5px";
                btn.style.background = opt.id === selectedFavicon ? "#555" : "#333";
                btn.style.display = "flex";
                btn.style.alignItems = "center";
                btn.style.justifyContent = "center";
                btn.style.padding = "0";
                btn.style.cursor = "pointer";
                btn.style.transition = "transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, border 0.3s ease, opacity 0.3s ease";
                btn.title = opt.title;
                btn.innerHTML = `<img src="${opt.icon}" alt="${opt.title}" style="width: 80%; height: 80%;">`;
                btn.addEventListener('click', () => {
                    selectedFavicon = opt.id;
                    document.querySelectorAll('#faviconButtons button, #userFaviconsContainer button').forEach(b => {
                        const isSelected = b.id === 'toggle' + selectedFavicon.charAt(0).toUpperCase() + selectedFavicon.slice(1);
                        // Ensure smooth transitions on both selection and deselection:
                        b.style.transition = "background-color 0.3s ease, border 0.3s ease";
                        b.style.background = isSelected ? "#555" : "#333";
                        b.style.border = isSelected ? "1px solid #3b82f6" : "1px solid #ccc";
                    });
                });
                btn.addEventListener('mouseover', () => {
                    btn.style.transform = "scale(1.1)";
                    btn.style.boxShadow = "0 6px 12px rgba(211,211,211,0.3)";
                });
                btn.addEventListener('mouseout', () => {
                    btn.style.transform = "scale(1)";
                    btn.style.boxShadow = "none";
                });
                btn.addEventListener('mousedown', () => { btn.style.background = "#555"; });
                btn.addEventListener('mouseup', () => {
                    btn.style.background = opt.id === selectedFavicon ? "#555" : "#333";
                });
                row.appendChild(btn);
            });
            if (includeToggleButton) {
                const toggleButton = renderToggleButton(
                    showOnlyPinned
                        ? "https://cdn-icons-png.flaticon.com/512/8212/8212729.png"
                        : "https://cdn-icons-png.flaticon.com/512/271/271228.png",
                    showOnlyPinned ? "Show All Icons" : "Show Only Pinned Icons",
                    () => {
                        if (!showOnlyPinned) {
                            animateHideNonPinned();
                        } else {
                            const toggleBtn = document.querySelector('.toggleButton');
                            if (toggleBtn) {
                                toggleBtn.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                                toggleBtn.style.transform = "translateY(10px)";
                                toggleBtn.style.opacity = "0";
                                setTimeout(() => {
                                    showOnlyPinned = false;
                                    renderFaviconRowsWithAnimation();
                                }, 200);
                            } else {
                                showOnlyPinned = false;
                                renderFaviconRowsWithAnimation();
                            }
                        }
                    },
                    !showOnlyPinned
                );
                toggleButton.style.marginLeft = "15px";
                row.appendChild(toggleButton);
                if (!showOnlyPinned) {
                    const expandButton = renderToggleButton(
                        "https://cdn-icons-png.flaticon.com/512/8212/8212729.png",
                        "Expand Favicons",
                        toggleExpandFavicon
                    );
                    expandButton.style.marginLeft = "10px";
                    row.appendChild(expandButton);
                }
            }
            container.appendChild(row);
            return container;
        }

        function renderFaviconRows() {
            faviconButtons.innerHTML = ''; // Clear the container

            if (showOnlyPinned) {
                const pinnedRow = renderFaviconRow(pinnedFavicons, "Pinned Favicons", true, true);
                faviconButtons.appendChild(pinnedRow);
            } else {
                const pinnedRow = renderFaviconRow(pinnedFavicons, "Pinned Favicons", true);
                faviconButtons.appendChild(pinnedRow);

                const googleRow = renderFaviconRow(googleFavicons, "Google");
                faviconButtons.appendChild(googleRow);

                const mpsRow = renderFaviconRow(mpsFavicons, "MPS");
                faviconButtons.appendChild(mpsRow);

                const nonGoogleRow = renderFaviconRow(nonGoogleFavicons, "Uncategorized", false, true);
                faviconButtons.appendChild(nonGoogleRow);
            }
            renderUserFavicons(); // render the user favicons below the clone bar
        }

        function renderUserFavicons() {
            const userContainer = document.getElementById('userFaviconsContainer');
            userContainer.innerHTML = '';
            if (userFavicons.length > 0) {
                // Force the container to be visible so computed style returns "block"
                userContainer.style.display = "block";
                // Show user favicons directly (no extra button)
                const userRow = renderFaviconRow(userFavicons, "User Favicons");
                userContainer.appendChild(userRow);
            }
        }

        function renderFaviconRowsWithAnimation() {
            faviconButtons.innerHTML = ''; // Clear the container
            
            console.log("Favicons row opening animation triggered, setting isFaviconRowVisible to true");
            isFaviconRowVisible = true;
            
            let pinnedRow;
            if (showOnlyPinned) {
                pinnedRow = renderFaviconRow(pinnedFavicons, "Pinned Favicons", true, true);
                faviconButtons.appendChild(pinnedRow);
            } else {
                pinnedRow = renderFaviconRow(pinnedFavicons, "Pinned Favicons", true);
                const googleRow = renderFaviconRow(googleFavicons, "Google");
                const mpsRow = renderFaviconRow(mpsFavicons, "MPS");
                const nonGoogleRow = renderFaviconRow(nonGoogleFavicons, "Uncategorized", false, true);
                faviconButtons.appendChild(pinnedRow);
                faviconButtons.appendChild(googleRow);
                faviconButtons.appendChild(mpsRow);
                faviconButtons.appendChild(nonGoogleRow);
            }
            
            const buttonDelay = 50;
            const interRowDelay = 25;
            const labelDelay = 100;
            let cumulativeDelay = 0;
            const nonPinnedContainers = Array.from(faviconButtons.children)
                 .filter(container => !container.classList.contains("pinnedRow"));
            nonPinnedContainers.forEach(container => {
                 const label = container.firstElementChild;
                 if (label) {
                     label.style.opacity = "0";
                     label.style.transform = "translateY(-10px)";
                     setTimeout(() => {
                         label.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                         label.style.transform = "translateY(0)";
                         label.style.opacity = "1";
                     }, cumulativeDelay);
                 }
                 const btnRow = container.querySelector('div:last-child');
                 if (btnRow) {
                     const buttons = Array.from(btnRow.querySelectorAll('button'));
                     buttons.forEach(btn => {
                         btn.style.opacity = "0";
                         btn.style.transform = "translateX(-30px)";
                     });
                     buttons.forEach((btn, i) => {
                         setTimeout(() => {
                             btn.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                             btn.style.transform = "translateX(0)";
                             btn.style.opacity = "1";
                             setTimeout(() => {
                                 btn.classList.add("bounce");
                                 setTimeout(() => {
                                     btn.classList.remove("bounce");
                                 }, 400);
                             }, 150);
                         }, cumulativeDelay + labelDelay + i * buttonDelay);
                     });
                     cumulativeDelay += labelDelay + buttons.length * buttonDelay + interRowDelay;
                 }
            });

            console.log("renderFaviconRowsWithAnimation - cumulativeDelay:", cumulativeDelay);
            console.log("renderFaviconRowsWithAnimation - userFavicons.length:", userFavicons.length);
            console.log("renderFaviconRowsWithAnimation - showUserFavicons:", showUserFavicons);

            const userContainer = document.getElementById('userFaviconsContainer');
            // Change condition to rely on showUserFavicons instead of userFaviconsActivated.
            if (showUserFavicons && userFavicons.length > 0) {
                isUserAnimationPlaying = true;
                userContainer.style.display = "block";
                console.log("Starting user favicons opening animation. isUserAnimationPlaying =", isUserAnimationPlaying);
                setTimeout(() => {
                    animateUserFavicons();
                    setTimeout(() => {
                        isUserAnimationPlaying = false;
                        console.log("User favicons opening animation completed. isUserAnimationPlaying =", isUserAnimationPlaying);
                    }, 500);
                }, cumulativeDelay + 150);
            } else {
                console.log("User favicons not activated; hiding user favicons container");
                userContainer.style.display = "none";
            }
        }

        function animateHideNonPinned() {
            console.log("Favicons row closing animation triggered, setting isFaviconRowVisible to false");
            isFaviconRowVisible = false;
            
            let initialDelay = 0;
            const expandContainer = document.getElementById('expandFaviconContainer');
            const userContainer = document.getElementById('userFaviconsContainer');

            if (userContainer) {
                userContainer.style.transition = "transform 0.2s ease, opacity 0.2s ease, display 0.2s ease";
                userContainer.style.transform = "translateY(-10px)";
                userContainer.style.opacity = "0";
                setTimeout(() => {
                    userContainer.style.display = "none"; // Hide the container after collapsing
                }, 200); // Match the transition duration
            }

            function animateOtherRows() {
                const buttonDelay = 50, interRowDelay = 25, labelDelay = 100;
                let cumulativeDelay = initialDelay;
                const nonPinnedContainers = Array.from(faviconButtons.children)
                     .filter(container => !container.classList.contains("pinnedRow"))
                     .reverse();
                nonPinnedContainers.forEach(container => {
                    // Animate buttons
                    const btnRow = container.querySelector('div:last-child');
                    if (btnRow) {
                        const buttons = Array.from(btnRow.querySelectorAll('button')).slice().reverse();
                        buttons.forEach((btn, i) => {
                            setTimeout(() => {
                                btn.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                                btn.style.transform = "translateX(-30px)";
                                btn.style.opacity = "0";
                            }, cumulativeDelay + i * buttonDelay);
                        });
                        // Animate label after buttons vanish
                        const label = container.firstElementChild;
                        if (label) {
                            setTimeout(() => {
                                label.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                                label.style.transform = "translateY(-10px)";
                                label.style.opacity = "0";
                            }, cumulativeDelay + buttons.length * buttonDelay + interRowDelay);
                        }
                        cumulativeDelay += labelDelay + buttons.length * buttonDelay + interRowDelay;
                    }
                });
                let totalDelay = cumulativeDelay + 150;
                setTimeout(() => {
                    showOnlyPinned = true;
                    // Reset activation so that user favicons are not shown unintentionally.
                    userFaviconsActivated = false;
                    if(userFavicons.length === 0) {
                        showUserFavicons = false;
                    }
                    renderFaviconRowsWithAnimation();
                    const toggleBtn = faviconButtons.querySelector('.pinnedRow .toggleButton');
                    if (toggleBtn) {
                        toggleBtn.style.opacity = "0";
                        toggleBtn.style.transform = "translateY(10px)";
                        setTimeout(() => {
                            toggleBtn.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                            toggleBtn.style.opacity = "1";
                            toggleBtn.style.transform = "translateY(0)";
                        }, 50);
                    }
                }, totalDelay);
            }

            if (expandContainer && expandContainer.style.display !== "none") {
                expandContainer.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                expandContainer.style.transform = "translateX(-30px)";
                expandContainer.style.opacity = "0";
                setTimeout(() => {
                    expandContainer.style.display = "none";
                    let delay = animateOtherRows();
                }, 150);
            } else {
                animateOtherRows();
            }
        }

        function animateUserFavicons() {
            const userContainer = document.getElementById('userFaviconsContainer');
            if (userContainer && userContainer.innerHTML.trim() !== '') {
                // Ensure container is visible and set initial state: slide in from left with a slight down offset and opacity 0.
                userContainer.style.display = "block";
                userContainer.style.transition = "transform 0.3s ease, opacity 0.3s ease";
                userContainer.style.transform = "translate(-30px, 10px)";
                userContainer.style.opacity = "0";
                
                // Animate individual buttons (which already slide in from left)
                const btnRow = userContainer.querySelector('div:last-child');
                if (btnRow) {
                    const buttons = Array.from(btnRow.querySelectorAll('button'));
                    buttons.forEach(btn => {
                        btn.style.opacity = "0";
                        btn.style.transform = "translateX(-30px)";
                    });
                    buttons.forEach((btn, i) => {
                        setTimeout(() => {
                            btn.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                            btn.style.transform = "translateX(0)";
                            btn.style.opacity = "1";
                            // Trigger simple up-and-down movement using the bounce class (which is defined in CSS)
                            setTimeout(() => {
                                btn.classList.add("bounce");
                                setTimeout(() => {
                                    btn.classList.remove("bounce");
                                }, 400);
                            }, 150);
                        }, i * 50);
                    });
                }
                setTimeout(() => {
                    // Animate container into view
                    userContainer.style.transform = "translate(0, 0)";
                    userContainer.style.opacity = "1";
                }, 50);
            }
        }

        // NEW: Dedicated function to render the user favicon row
        function renderUserFaviconsDirect() {
            // Clear and show the user favicons container
            const userContainer = document.getElementById('userFaviconsContainer');
            userContainer.innerHTML = '';
            if (userFavicons.length > 0) {
                userContainer.style.display = "block";
                const userRow = renderFaviconRow(userFavicons, "User Favicons");
                userContainer.appendChild(userRow);
            } else {
                userContainer.style.display = "none";
            }
        }

        // Updated global toggle function for expand/collapse behavior.
        function toggleExpandFavicon(event) {
            if (event && event.currentTarget && event.currentTarget.title === "Expand Favicons") {
                const btn = event.currentTarget;
                btn.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                btn.style.opacity = "0";
                btn.style.transform = "translateY(10px)";
                setTimeout(() => {
                    btn.remove();
                }, 250);
            }
            if (event && event.currentTarget && event.currentTarget.closest('#cloneControlsContainer')) {
                const btn = event.currentTarget;
                btn.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                btn.style.opacity = "0";
                btn.style.transform = "translateY(10px)";
                setTimeout(() => {
                    btn.remove();
                }, 250);
                return;
            }
            const expandContainer = document.getElementById('expandFaviconContainer');
            const cloneContainer = document.getElementById('cloneControlsContainer');
            const originalRow = faviconButtons.querySelector('.pinnedRow');
            if (!originalRow) return;
            if (showOnlyPinned) {
                showOnlyPinned = false;
                showUserFavicons = true; // Ensure user favicons row will be displayed.
                userFaviconsActivated = true; // Activate only when "Expand Favicons" is clicked.
                renderFaviconRowsWithAnimation();
                // Directly render user favicons via the dedicated function:
                renderUserFaviconsDirect();
                return;
            }
            // Define inner function to show the clone favicon bar.
            const showCloneFaviconBar = () => {
                const controls = originalRow.querySelectorAll('button.toggleButton, button[title="Expand Favicons"], button[title="Hide Favicons"]');
                controls.forEach(control => {
                    control.style.display = "none";
                });
                expandContainer.style.display = "block";
                expandContainer.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                expandContainer.style.transform = "translateX(-30px)";
                expandContainer.style.opacity = "0";
                setTimeout(() => {
                    expandContainer.style.transform = "translateX(0)";
                    expandContainer.style.opacity = "1";
                }, 0);
                cloneContainer.innerHTML = "";
                controls.forEach(control => {
                    const clone = document.createElement('button');
                    clone.innerHTML = control.innerHTML;
                    clone.title = control.title;
                    clone.className = control.className;
                    clone.style.width = control.style.width;
                    clone.style.height = control.style.height;
                    clone.style.border = control.style.border;
                    clone.style.borderRadius = control.style.borderRadius;
                    clone.style.background = control.style.background;
                    clone.style.marginLeft = "0"; // center clone
                    clone.addEventListener('click', toggleExpandFavicon, { once: true });
                    cloneContainer.appendChild(clone);
                });
                cloneContainer.style.display = "block";
                cloneContainer.style.transition = "transform 0.2s ease, opacity 0.2s ease";
                cloneContainer.style.transform = "translateX(-30px)";
                cloneContainer.style.opacity = "0";
                setTimeout(() => {
                    cloneContainer.style.transform = "translateX(0)";
                    cloneContainer.style.opacity = "1";
                }, 0);
            };
            if (expandContainer.style.display === "none" || expandContainer.style.opacity === "0") {
                if (event && event.currentTarget && event.currentTarget.title === "Expand Favicons") {
                    setTimeout(showCloneFaviconBar, 250);
                } else {
                    showCloneFaviconBar();
                }
            } else {
                expandContainer.style.display = "none";
                cloneContainer.style.display = "none";
                cloneContainer.innerHTML = "";
                const controls = originalRow.querySelectorAll('button.toggleButton, button[title="Expand Favicons"], button[title="Hide Favicons"]');
                controls.forEach(control => {
                    control.style.display = "block";
                });
            }
        }

        function fetchData(targetUrl) {
            const endpoint = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(targetUrl);
            return fetch(endpoint)
                .then(res => {
                    if (!res.ok) throw new Error('Network error: ' + res.status);
                    return res.text();      // raw HTML string
                });
        }

        // Updated cloneFavicon: remove unnecessary alerts and push new favicon into userFavicons
        function cloneFavicon() {
            let url = document.getElementById('expandUrlInput').value.trim();
            if (!url) {
                alert("Please enter a URL.");
                return;
            }
            if (!/^https?:\/\//.test(url)) url = 'https://' + url;
            
            let hostname;
            try {
                hostname = new URL(url).hostname;
            } catch (e) {
                alert("Invalid URL.");
                return;
            }
            
            // --- Updated favicon URL generation in cloneFavicon ---
            const faviconUrl = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(hostname)}&sz=64`;
            
            // Create a temporary user favicon with spinner and "Loading..." title
            const tempId = 'user' + Date.now();
            const tempFavicon = {
                id: tempId,
                title: "Loading...",
                icon: "https://i.gifer.com/origin/b4/b4d657e7ef262b88eb5f7ac021edda87_w200.gif",
                head: `<title>Loading...</title><link rel="icon" type="image/x-icon" href="https://i.gifer.com/origin/b4/b4d657e7ef262b88eb5f7ac021edda87_w200.gif">`
            };
            userFavicons.push(tempFavicon);
            selectedFavicon = tempId;
            showUserFavicons = true;
            renderFaviconRows();
            
            fetchData(url)
                .then(html => {
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const og = doc.querySelector('meta[property="og:title"]');
                    const tt = doc.querySelector('title');
                    let title = og?.content || tt?.innerText;
                    if (!title) {
                        try {
                            title = new URL(url).hostname.replace('www.', '').replace(/^https?:\/\//, '');
                        } catch {
                            title = 'Untitled Document';
                        }
                    }
                    // Update temporary favicon data
                    tempFavicon.title = title;
                    tempFavicon.icon = faviconUrl;
                    tempFavicon.head = `<title>${title}</title><link rel="icon" type="image/x-icon" href="${faviconUrl}">`;
                    renderFaviconRows();
                    document.getElementById('expandUrlInput').value = '';
                    const expandFaviconsButton = document.querySelector('button[title="Expand Favicons"]');
                    if (expandFaviconsButton) {
                        expandFaviconsButton.remove();
                    }
                })
                .catch(err => {
                    alert("Error loading favicon: " + err.message);
                    userFavicons = userFavicons.filter(fav => fav.id !== tempId);
                    renderFaviconRows();
                });
        }

        let fileContent = '';
        let temporarySelected = true;  // new flag

        document.addEventListener('DOMContentLoaded', () => {
            // Set the temporary file to be the current site content and update the file label to the page's title.
            fileContent = document.documentElement.outerHTML;
            const browseLabel = document.getElementById('browseLabel');
            browseLabel.textContent = document.title;
            renderFaviconRows(); // Render rows initially without animation
            const cloneButton = document.getElementById('cloneFaviconButton');
            cloneButton.addEventListener('click', cloneFavicon);
        });

        // New: Clear temporary file if user types in the URL bar.
        urlInput.addEventListener('input', function() {
            if (temporarySelected && this.value.trim() !== '') {
                fileContent = '';
                temporarySelected = false;
                const browseLabel = document.getElementById('browseLabel');
                browseLabel.textContent = 'Drag and drop or click to upload an HTML file';
            }
        });

        toggleVisibility.addEventListener('click', () => {
        if(urlInput.type === 'password') {
            urlInput.type = 'text';
            toggleVisibility.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/32/159/159604.png" alt="Show text" style="width: 90%; height: 90%;">';
        } else {
            urlInput.type = 'password';
            toggleVisibility.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/32/10812/10812267.png" alt="Hide text" style="width: 90%; height: 90%;">';
        }
        });

        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            const validTypes = [
                'text/html',
                'application/x-mimearchive' // For MHTML files
            ];
            
            const validExtensions = ['.html', '.htm', '.mhtml'];
            const fileExt = file?.name.slice(file.name.lastIndexOf('.')).toLowerCase();
            
            console.log('File selected:', file?.name);
            
            if (file && (validExtensions.includes(fileExt) || validTypes.includes(file.type))) {
                fileContent = await file.text();
                browseLabel.textContent = file.name;
                console.log('Valid HTML file loaded:', file.name);
            } else {
                console.error('Invalid file type:', file?.name);
                fileInput.value = '';
                browseLabel.textContent = 'Drag and drop or click to upload an HTML file';
            }
        });

        clearFileButton.addEventListener('click', () => {
        fileInput.value = '';
        fileContent = '';
        browseLabel.textContent = 'Drag and drop or click to upload an HTML file';
        });

        clearUrlButton.addEventListener('click', () => {
        urlInput.value = '';
        });

        openButton.addEventListener('click', openInNewWindow);

        document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            openInNewWindow();
        }
        });

        function openInNewWindow() {
            const win = window.open("", "_blank");
            if (!win) return;
            const selectedFav = [...faviconOptions, ...userFavicons].find(f => f.id === selectedFavicon);
            const iconUrl = selectedFav?.icon || '';
            const headContent = `
                <title>${selectedFav?.title || 'New Tab'}</title>
                <link rel="icon" type="image/x-icon" href="${iconUrl}">
                <link rel="shortcut icon" href="${iconUrl}">
                ${selectedFav?.head || ''}
                <script>
                    // Force favicon refresh for Chrome
                    setTimeout(() => {
                        const links = document.querySelectorAll('link[rel*="icon"]');
                        links.forEach(link => link.remove());
                        const newLink = document.createElement('link');
                        newLink.rel = 'icon';
                        newLink.href = '${iconUrl}?' + Date.now();
                        document.head.appendChild(newLink);
                    }, 300);
                <\/script>
            `;
            win.document.write(`
                <html>
                    <head>
                        ${headContent}
                        <style>
                            body { margin: 0; height: 100vh; overflow: hidden; }
                            iframe { width: 100%; height: 100%; border: none; }
                            /* Ensure font inheritance */
                            #topBar, #topBar input, #topBar button, #topBar label {
                                font-family: 'Funnel Display', 'Open Sans', sans-serif !important;
                                letter-spacing: 0.02em;
                            }
                            
                            /* New fullscreen toggle styles */
                            #fullscreenToggle {
                                position: fixed;
                                top: 10px;
                                right: 10px;
                                z-index: 10000;
                                width: 24px;
                                height: 24px;
                                background: rgba(255, 255, 255, 0.1);
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                opacity: 0;
                                transition: opacity 0.2s ease;
                                display: none;
                            }
                            
                            #fullscreenToggle:hover {
                                background: rgba(255, 255, 255, 0.2);
                            }
                            
                            #fullscreenToggle::after {
                                content: "▼";
                                color: white;
                                font-size: 12px;
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                            }
                            
                            #fullscreenToggle.visible {
                                opacity: 1;
                            }

                            #showTopBarToggle {
                                background: rgba(255, 255, 255, 0.15);
                                mix-blend-mode: difference;
                                border-radius: 4px;
                                transition: background 0.3s ease;
                            }

                            #showTopBarToggle:hover {
                                background: rgba(255, 255, 255, 0.25);
                            }

                            #showTopBarToggle {
                                position: fixed;
                                top: 10px;
                                right: 10px;
                                z-index: 10000;
                                width: 24px;
                                height: 24px;
                                background: rgba(255, 255, 255, 0.1);
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                opacity: 0;
                                transition: opacity 0.3s ease, transform 0.3s ease !important;
                                pointer-events: none;
                                will-change: opacity, transform;
                                justify-content: center;
                                align-items: center;
                                padding: 0;
                                display: none;
                            }
                            
                            #showTopBarToggle span {
                                display: block;
                                transform: translateY(-1px); /* Optical alignment */
                                width: 100%;
                                text-align: center;
                            }

                            /* New attribute selector rule */
                            #showTopBarToggle[hidden] {
                                display: none !important;
                            }

                            .material-symbols-outlined {
                                font-variation-settings: 'FILL' 0, 'GRAD' 0, 'opsz' 24;
                                font-family: 'Material Symbols Outlined' !important;
                            }
                        </style>
                    </head>
                    <body>
                        <div id="topBar" style="position: fixed; top: 0; left: 0; right: 0; height: 40px; background: #333; display: flex; align-items: center; padding: 0 10px; gap: 10px; z-index: 1000; transition: top 0.3s ease; font-family: 'Funnel Display', 'Open Sans', sans-serif;">
                            
                            <!-- URL Input -->
                            <input type="text" id="navUrl" class="topbar-input" placeholder="Enter URL" 
                                style="width: 33%; height: 32px; background: #1e1e1e; border: 1px solid #555;
                                       color: #e0e0e0; padding: 0 10px; border-radius: 4px; flex-shrink: 0;">

                            <!-- Updated Upload Button container -->
                            <div style="position: relative; width: 120px; height: 32px; margin-left: 10px; flex-shrink: 0;">
                                <input type="file" id="topUpload" 
                                       accept=".html,.htm,.mhtml,text/html"
                                       style="opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer;">
                                <label for="topUpload" 
                                       style="display: flex; align-items: center; height: 100%; color: #e0e0e0; 
                                              cursor: pointer; padding: 0 8px; border: 1px dashed #666; border-radius: 4px;
                                              justify-content: center; font-size: 14px; width: 100%; box-sizing: border-box;">
                            Upload HTML
                        </label>
                            </div>

                            <!-- New Refresh Button -->
                            <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
    <button id="refreshBtn" 
            style="background: none; border: none; padding: 4px; cursor: pointer; height: 32px;">
        <img src="https://cdn-icons-png.flaticon.com/512/2805/2805355.png" 
             alt="Refresh" 
             style="width: 24px; height: 24px; filter: invert(1) brightness(2);">
    </button>
</div>

                            <!-- Spacer -->
                            <div style="flex-grow: 1;"></div>

                            <!-- Control Buttons -->
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <!-- Hide button (original size) -->
                                <button id="hideBarBtn" class="topbar-button" 
                                        style="background: none; border: none; padding: 4px; cursor: pointer;">
                                    <img src="https://cdn-icons-png.flaticon.com/512/25/25678.png" 
                                         alt="Hide" 
                                         style="width: 24px; height: 24px; filter: invert(1) brightness(2);">
                                </button>
                                <button id="fullscreenBtn" class="topbar-button" 
                                        style="background: none; border: none; padding: 4px; cursor: pointer;">
                                    <img src="https://cdn-icons-png.flaticon.com/512/483/483333.png" alt="Fullscreen" 
                                         style="width: 24px; height: 24px; filter: invert(1) brightness(2);">
                                </button>
                            </div>
                        </div>
                        <!-- Show topbar toggle button (scaled down arrow) -->
                        <button id="showTopBarToggle" style="display: none;">
                            <img src="https://cdn-icons-png.flaticon.com/512/25/25678.png" 
                                 alt="Show" 
                                 style="width: 24px; height: 24px;
                                        filter: invert(1) brightness(2) drop-shadow(0 1px 1px rgba(0,0,0,0.3));
                                        transform: rotate(180deg) scale(0.8);
                                        transform-origin: center;">
                        </button>
                        <div id="contentContainer" style="position: fixed; top: 40px; left: 0; right: 0; bottom: 0; transition: top 0.3s ease;"></div>
                        <button id="fullscreenToggle"></button>
                        <script>
                            // Updated navUrl event listener in openInNewWindow()
                            document.addEventListener('DOMContentLoaded', () => {
                                const navUrl = document.getElementById('navUrl');
                                let currentIframe = null; // Declare in window scope
                                navUrl.addEventListener('keydown', (e) => {
                                    if (e.key === 'Enter') {
                                        e.preventDefault();
                                        let url = navUrl.value.trim();
                                        if (!url) return;
                                        if (!/^https?:\\/\\//i.test(url)) {
                                            url = 'https://' + url;
                                        }
                                        console.log('Navigating to:', url); // Add console log
                                        if (!currentIframe) {
                                            currentIframe = document.createElement('iframe');
                                            currentIframe.style.width = "100%";
                                            currentIframe.style.height = "100%";
                                            currentIframe.style.border = "none";
                                            // Clear previous content first
                                            const container = document.getElementById('contentContainer');
                                            container.innerHTML = '';
                                            container.appendChild(currentIframe);
                                            // CSS fix:
                                            currentIframe.style.display = 'block';
                                            currentIframe.style.position = 'absolute';
                                        }
                                        currentIframe.src = url;
                                    }
                                });
                            });
                        <\/script>
                    </body>
                </html>
            `);
            
            // Finish parsing & fire DOMContentLoaded
            win.document.close();
            
            // Replace broken event listener with the new listener for navUrl:
            const navUrl = win.document.getElementById('navUrl');
            navUrl.focus();
            navUrl.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                let url = navUrl.value.trim();
                if (!/^https?:\/\//i.test(url)) {
                  url = 'https://' + url;
                }
                if (!currentIframe) {
                  currentIframe = win.document.createElement('iframe');
                  currentIframe.style.width = "100%";
                  currentIframe.style.height = "100%";
                  currentIframe.style.border = "none";
                  // Clear previous content first
                  const container = win.document.getElementById('contentContainer');
                  container.innerHTML = '';
                  container.appendChild(currentIframe);
                }
                currentIframe.src = url;
                console.log('Navigated to:', url);
              }
            });
            
            // Now, after the document is fully parsed, replace the favicon once
            setTimeout(() => {
                const head = win.document.head;
                // Remove any existing icon links
                head.querySelectorAll('link[rel*="icon"]').forEach(link => link.remove());
                // Inject a new one with a cache-busting timestamp
                const link = win.document.createElement('link');
                link.rel = 'icon';
                link.href = iconUrl + '?v=' + Date.now();
                head.appendChild(link);
            }, 300);

            const contentContainer = win.document.getElementById('contentContainer');
            const topBar = win.document.getElementById('topBar');
            const topUpload = win.document.getElementById('topUpload');
            const fullscreenToggle = win.document.getElementById('fullscreenToggle');
            let currentIframe = null;

            // Fullscreen handling
            function handleFullscreenChange() {
                if (!win.document.fullscreenElement) {
                    fullscreenToggle.style.display = 'none';
                    topBar.style.top = "0";
                    contentContainer.style.top = "40px";
                }
            }

            win.document.addEventListener('fullscreenchange', handleFullscreenChange);
            
            // Fullscreen button click handler
            win.document.getElementById('fullscreenBtn').addEventListener('click', () => {
                console.log('Fullscreen button clicked');
                
                // First try to fullscreen the iframe; fallback to the entire document element
                const targetElement = currentIframe || win.document.documentElement;
                
                if (!targetElement) {
                    console.warn('No element available for fullscreen');
                    return;
                }
                
                if (!document.fullscreenElement) {
                    targetElement.requestFullscreen()
                        .then(() => console.log('Entered fullscreen mode'))
                        .catch(err => console.error('Fullscreen error:', err));
                } else {
                    document.exitFullscreen()
                        .then(() => console.log('Exited fullscreen mode'));
                }
            });

            // Add fullscreen CSS to new window
            const fullscreenStyle = `
                #contentContainer:-webkit-full-screen {
                    width: 100% !important;
                    height: 100% !important;
                    background: #121212;
                }
                
                #contentContainer:-moz-full-screen {
                    width: 100% !important;
                    height: 100% !important;
                    background: #121212;
                }
                
                #contentContainer:fullscreen {
                    width: 100% !important;
                    height: 100% !important;
                    background: #121212;
                }
            `;
            win.document.head.insertAdjacentHTML('beforeend', `<style>${fullscreenStyle}</style>`);

            // Show topbar toggle functionality
            const showTopBarToggle = win.document.getElementById('showTopBarToggle');
            showTopBarToggle.addEventListener('click', () => {
                // Disable interaction during animation
                showTopBarToggle.style.pointerEvents = 'none';
                
                // Animate toggle out
                showTopBarToggle.style.opacity = '0';
                
                // Animate topbar in
                topBar.style.top = "0";
                contentContainer.style.top = "40px";
            
                // Re-enable interaction after animation completes
                setTimeout(() => {
                    showTopBarToggle.style.display = 'none';
                    showTopBarToggle.style.pointerEvents = 'auto';
                }, 300);
            });

            // Update the hide button handler
            win.document.getElementById('hideBarBtn').addEventListener('click', () => {
                // Disable interaction during animation
                showTopBarToggle.style.pointerEvents = 'none';
                
                // Animate topbar out
                topBar.style.top = "-40px";
                contentContainer.style.top = "0";
                
                // Animate toggle in after topbar animation finishes
                setTimeout(() => {
                    showTopBarToggle.style.display = 'flex';
                    showTopBarToggle.style.opacity = '1';
                    showTopBarToggle.style.pointerEvents = 'auto';
                }, 300);
            });

            // Add file upload handler for topUpload
            topUpload.addEventListener('change', async () => {
                const file = topUpload.files[0];
                const validExtensions = ['.html', '.htm', '.mhtml'];
                const fileExt = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
                
                if (file && validExtensions.includes(fileExt)) {
                    const content = await file.text();
                    loadContent(content);
                    console.log('HTML file loaded successfully');
                } else {
                    console.error('Invalid file type:', file.name);
                    topUpload.value = ''; // Clear invalid selection
                }
            });

            // Update loadContent function
            function loadContent(content) {
                currentIframe = win.document.createElement('iframe');
                currentIframe.srcdoc = content;
                currentIframe.style.width = "100%";
                currentIframe.style.height = "100%";
                currentIframe.style.border = "none";
                contentContainer.innerHTML = '';
                contentContainer.appendChild(currentIframe);
            }

            // Initial content load
            if (fileContent) {
                loadContent(fileContent);
            } else {
                const initialUrl = urlInput.value.trim();
                if (initialUrl) {
                    currentIframe = win.document.createElement('iframe');
                    currentIframe.style.width = "100%";
                    currentIframe.style.height = "100%";
                    currentIframe.style.border = "none";
                    currentIframe.src = /^https?:\/\//i.test(initialUrl)
                        ? initialUrl
                        : `https://${initialUrl}`;
                    contentContainer.appendChild(currentIframe);
                }
            }

            // Updated refresh logic in the new window's script section
    const refreshBtn = win.document.getElementById('refreshBtn');

    refreshBtn.addEventListener('click', () => {
        if (!currentIframe) return;
        // For file content (srcdoc)
        if (currentIframe.contentDocument?.URL === 'about:srcdoc') {
            currentIframe.srcdoc = currentIframe.srcdoc;
        }
        // For websites
        else if (currentIframe.src) {
            // Clone the iframe to force fresh load
            const newIframe = document.createElement('iframe');
            newIframe.style.cssText = currentIframe.style.cssText;
            newIframe.src = currentIframe.src;
            contentContainer.replaceChild(newIframe, currentIframe);
            currentIframe = newIframe;
        }
    });

    // URL bar handler
navUrl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const url = navUrl.value.trim();
        if (!url) return;

        // Completely remove existing iframe
        if (currentIframe) {
            contentContainer.removeChild(currentIframe);
            currentIframe = null;
        }

        // Create new iframe with fresh attributes
        currentIframe = document.createElement('iframe');
        currentIframe.style.width = "100%";
        currentIframe.style.height = "100%";
        currentIframe.style.border = "none";
        currentIframe.style.display = "block";
        currentIframe.style.position = "absolute";

        // Handle content type
        if (/\.html?$/.test(url) || url.startsWith('<')) {
            currentIframe.srcdoc = url;
        } else {
            const finalUrl = url.startsWith('http') ? url : `https://${url}`;
            currentIframe.src = finalUrl;
        }

        contentContainer.appendChild(currentIframe);
    }
});
}
        </script>
</body>
</html>